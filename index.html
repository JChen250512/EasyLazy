<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EazyLazyç·šä¸Šé ç´„</title>
    <style>
        /* --- CSS æ¨£å¼å€ --- */
        :root {
            --primary-color: #d4a373; /* è³ªæ„Ÿå¥¶èŒ¶è‰² */
            --bg-color: #fefae0;      /* æŸ”å’ŒèƒŒæ™¯ */
            --text-color: #4a4a4a;
        }

        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            background: white;
            width: 100%;
            max-width: 500px; /* æ‰‹æ©Ÿç‰ˆå¯¬åº¦å„ªåŒ– */
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        select, input[type="text"], input[type="tel"], input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’ç ´å¯¬åº¦ */
        }

        /* æœå‹™å¡ç‰‡æ¨£å¼ (æ¨¡æ“¬é¸å–®) */
        .service-info {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            display: none; /* é è¨­éš±è— */
        }

        /* æ™‚æ®µæŒ‰éˆ•å€åŸŸ */
        .time-slots {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .time-btn {
            padding: 10px;
            border: 1px solid var(--primary-color);
            background: white;
            color: var(--primary-color);
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }

        .time-btn.selected {
            background: var(--primary-color);
            color: white;
        }

        .time-btn:disabled {
            background: #eee;
            border-color: #ddd;
            color: #aaa;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        /* é€å‡ºæŒ‰éˆ• */
        .submit-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }

        .submit-btn:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>EazyLazyç¾ç«é ç´„</h1>
    
    <form id="bookingForm">
        <div class="form-group">
            <label for="service">é¸æ“‡æœå‹™é …ç›®</label>
            <select id="service" required onchange="updateServiceInfo()">
                <option value="" disabled selected>è«‹é¸æ“‡...</option>
                <option value="3d_natural" data-price="1200" data-time="90">3D è‡ªç„¶è£¸å¦æ¬¾ (90åˆ†)</option>
                <option value="6d_volume" data-price="1800" data-time="120">6D è¼•ç›ˆçˆ†æ¿ƒæ¬¾ (120åˆ†)</option>
                <option value="remove" data-price="500" data-time="30">ä»–åº—å¸é™¤ (30åˆ†)</option>
            </select>
            <div id="serviceDetail" class="service-info">
                ğŸ’° åƒ¹æ ¼: <span id="priceDisplay">0</span> å…ƒ | â± æ™‚é–“: <span id="timeDisplay">0</span> åˆ†é˜
            </div>
        </div>

        <div class="form-group">
            <label for="staff">æŒ‡å®šç¾ç«å¸«</label>
            <select id="staff" required>
                <option value="any">ä¸æŒ‡å®š (æœ€å¿«å®‰æ’)</option>
                <option value="peggy">Peggy è€å¸«</option>
                <!--
				<option value="claire">Claire è€å¸«</option>
				-->
            </select>
        </div>

        <div class="form-group">
            <label for="date">é ç´„æ—¥æœŸ</label>
            <input type="date" id="date" required onchange="generateTimeSlots()">
        </div>

        <div class="form-group">
            <label>é¸æ“‡æ™‚æ®µ</label>
            <div id="timeSlotsContainer" class="time-slots">
                <div style="grid-column: 1/-1; color: #888; text-align: center;">è«‹å…ˆé¸æ“‡æ—¥æœŸ</div>
            </div>
            <input type="hidden" id="selectedTime" required>
        </div>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

        <div class="form-group">
            <label for="name">æ‚¨çš„å§“å</label>
            <input type="text" id="name" placeholder="è«‹è¼¸å…¥å§“å" required>
        </div>

        <div class="form-group">
            <label for="phone">è¯çµ¡é›»è©±</label>
            <input type="tel" id="phone" placeholder="09xx-xxx-xxx" required>
        </div>
		
		<div style="display:none;">
			<label for="nickname">è«‹å‹¿å¡«å¯«</label>
			<input type="text" id="nickname" name="nickname">
		</div>

        <button type="submit" class="submit-btn">ç¢ºèªé ç´„</button>
    </form>
</div>

<script>
// --- JavaScript é‚è¼¯å€ ---

// 1. æœå‹™æ™‚é–“å°ç…§è¡¨ (ç”¨æ–¼è¨ˆç®—è¡çª)
const SERVICE_DETAILS = {
    '3d_natural': { text: '3D è‡ªç„¶è£¸å¦æ¬¾', price: 1200, time: 90 },
    '6d_volume': { text: '6D è¼•ç›ˆçˆ†æ¿ƒæ¬¾', price: 1800, time: 120 },
    'remove': { text: 'ä»–åº—å¸é™¤', price: 500, time: 30 }
};

// 2. è¼”åŠ©å‡½å¼ï¼šæ™‚é–“è™•ç† (å°‡ HH:MM è½‰ç‚ºåˆ†é˜æ•¸)
function timeToMinutes(timeStr) {
    const [hour, minute] = timeStr.split(':').map(Number);
    return hour * 60 + minute;
}

// 3. è¼”åŠ©å‡½å¼ï¼šæª¢æŸ¥å…©å€‹æ™‚æ®µæ˜¯å¦è¡çª
// SlotStartMin/SlotEndMin æ˜¯æˆ‘å€‘è¦æª¢æŸ¥çš„ç©ºæª” (ä¾‹å¦‚ 15:00 - 16:30)
// BookedStartMin/BookedEndMin æ˜¯å·²é ç´„çš„æ™‚æ®µ (ä¾‹å¦‚ 14:00 - 16:00)
function isTimeConflict(SlotStartMin, SlotEndMin, BookedStartMin, BookedEndMin) {
    // æª¢æŸ¥æ˜¯å¦æœ‰é‡ç–Šï¼šå¦‚æœçµæŸæ™‚é–“åœ¨å°æ–¹é–‹å§‹æ™‚é–“ä¹‹å¾Œ AND é–‹å§‹æ™‚é–“åœ¨å°æ–¹çµæŸæ™‚é–“ä¹‹å‰
    return SlotStartMin < BookedEndMin && SlotEndMin > BookedStartMin;
}

// 4. æ›´æ–°æœå‹™è³‡è¨Šé¡¯ç¤º (èˆ‡èˆŠç‰ˆç›¸åŒï¼Œä½†ç¾åœ¨æœƒå„²å­˜ duration)
let selectedServiceDuration = 0; // å…¨åŸŸè®Šæ•¸ï¼Œå„²å­˜é¸å®šçš„æœå‹™æ™‚é•·
function updateServiceInfo() {
    const serviceSelect = document.getElementById('service');
    const serviceKey = serviceSelect.value;
    const detailDiv = document.getElementById('serviceDetail');
    
    if (serviceKey) {
        const detail = SERVICE_DETAILS[serviceKey];
        document.getElementById('priceDisplay').innerText = detail.price;
        document.getElementById('timeDisplay').innerText = detail.time;
        detailDiv.style.display = 'block';
        
        // å„²å­˜é¸å®šæœå‹™çš„æ™‚é•·
        selectedServiceDuration = detail.time;

        // æ›´æ–°æœå‹™å¾Œï¼Œè‡ªå‹•é‡æ–°ç”Ÿæˆæ™‚æ®µ
        generateTimeSlots();
    } else {
         detailDiv.style.display = 'none';
         selectedServiceDuration = 0;
    }
}


// 5. å¾ Google Sheet è®€å–æ‰€æœ‰é ç´„è³‡æ–™
async function fetchBookedAppointments(date) {
    // ä½¿ç”¨æ‚¨åœ¨æ­¥é©Ÿä¸‰æ‹¿åˆ°çš„ Web App URL (POST & GET çš†ç”¨æ­¤ç¶²å€)
    const scriptURL = 'è«‹åœ¨é€™è£¡è²¼ä¸Šæ‚¨çš„_GOOGLE_SCRIPT_ç¶²å€'; 

    try {
        const response = await fetch(scriptURL, {
            method: 'GET'
        });
        
        if (!response.ok) {
            console.error('Fetch error:', response.statusText);
            return [];
        }
        
        const allAppointments = await response.json();
        
        // éæ¿¾å‡ºèˆ‡æ‰€é¸æ—¥æœŸç›¸ç¬¦çš„é ç´„
        const todayBookings = allAppointments.filter(app => 
            // è©¦ç®—è¡¨ä¸­çš„æ—¥æœŸæ ¼å¼æ˜¯ YYYY/MM/DD, ç¶²é é¸å–çš„æ˜¯ YYYY-MM-DD
            app['é ç´„æ—¥æœŸ'] && app['é ç´„æ—¥æœŸ'].includes(date.replace(/-/g, '/'))
        );
        
        return todayBookings;

    } catch (error) {
        console.error('è®€å–é ç´„è³‡æ–™å¤±æ•—:', error);
        return [];
    }
}


// 6. æ¨¡æ“¬ç”¢ç”Ÿæ™‚æ®µ (åŒ…å«è¡çªæª¢æŸ¥é‚è¼¯)
async function generateTimeSlots() {
    const container = document.getElementById('timeSlotsContainer');
    const dateInput = document.getElementById('date');
    const selectedDate = dateInput.value;
    
    container.innerHTML = ''; // æ¸…ç©ºèˆŠæŒ‰éˆ•
    
    // æª¢æŸ¥æ˜¯å¦å·²é¸æ“‡æœå‹™å’Œæ—¥æœŸ
    if (selectedServiceDuration === 0) {
        container.innerHTML = '<div style="grid-column: 1/-1; color: #888; text-align: center;">è«‹å…ˆé¸æ“‡æœå‹™é …ç›®èˆ‡æ—¥æœŸ</div>';
        return;
    }

    if (!selectedDate) {
         container.innerHTML = '<div style="grid-column: 1/-1; color: #888; text-align: center;">è«‹é¸æ“‡æ—¥æœŸ</div>';
         return;
    }
    
    // è®€å–ç•¶æ—¥å·²é ç´„çš„è³‡æ–™
    const bookedAppointments = await fetchBookedAppointments(selectedDate);
    
    // æ¨¡æ“¬ç‡Ÿæ¥­æ™‚é–“ 10:00 - 18:00 (æ¯ 30 åˆ†é˜ä¸€å€‹æ™‚æ®µ)
    const startHour = 10;
    const endHour = 18;
    const intervalMinutes = 30; // ä»¥ 30 åˆ†é˜ç‚ºæœ€å°é ç´„å–®ä½

    let availableCount = 0;

    for (let currentMin = timeToMinutes(`${startHour}:00`); 
         currentMin < timeToMinutes(`${endHour}:00`); 
         currentMin += intervalMinutes) {
        
        // å°‡åˆ†é˜è½‰å› HH:MM æ ¼å¼
        const hour = Math.floor(currentMin / 60);
        const minute = currentMin % 60;
        const timeLabel = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
        
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'time-btn';
        btn.innerText = timeLabel;

        // --- æ ¸å¿ƒè¡çªæª¢æŸ¥é‚è¼¯ ---
        let isBooked = false;
        
        // 1. è¨ˆç®—å®¢æˆ¶æ‰€éœ€æ™‚æ®µ (å¾ç•¶å‰æ™‚æ®µé–‹å§‹ï¼ŒåŠ ä¸Šæœå‹™æ™‚é•·)
        const clientSlotStartMin = currentMin;
        const clientSlotEndMin = currentMin + selectedServiceDuration; 

        // 2. ç¢ºä¿çµæŸæ™‚é–“åœ¨ç‡Ÿæ¥­æ™‚é–“å…§
        if (clientSlotEndMin > timeToMinutes(`${endHour}:00`)) {
             // å¦‚æœæ­¤æ™‚æ®µé ç´„ä¸‹å»æœƒè¶…éç‡Ÿæ¥­æ™‚é–“ï¼Œå‰‡ä¸å¯é¸
             isBooked = true;
        } else {
            // 3. æª¢æŸ¥èˆ‡æ‰€æœ‰å·²é ç´„æ™‚æ®µçš„è¡çª
            for (const app of bookedAppointments) {
                // å¾æœå‹™é …ç›®åç¨±ï¼ŒåæŸ¥å·²é ç´„å–®çš„æ™‚é•·
                const bookedServiceKey = Object.keys(SERVICE_DETAILS).find(key => 
                    SERVICE_DETAILS[key].text === app['æœå‹™é …ç›®']
                );
                
                // å‡è¨­é ç´„å–®çš„æ™‚é•·ç‚º 90 åˆ†é˜ (å¦‚æœæ‰¾ä¸åˆ°æœå‹™é …ç›®å°±çµ¦ä¸€å€‹é è¨­å€¼)
                const bookedDuration = bookedServiceKey ? SERVICE_DETAILS[bookedServiceKey].time : 90;
                
                const bookedStartMin = timeToMinutes(app['é ç´„æ™‚æ®µ']);
                const bookedEndMin = bookedStartMin + bookedDuration;

                if (isTimeConflict(clientSlotStartMin, clientSlotEndMin, bookedStartMin, bookedEndMin)) {
                    isBooked = true;
                    break; // æ‰¾åˆ°ä¸€å€‹è¡çªå°±åœæ­¢æª¢æŸ¥
                }
            }
        }
        
        if (isBooked) {
            btn.disabled = true;
            btn.title = "æ™‚æ®µå·²è¢«é ç´„æˆ–é•·åº¦ä¸è¶³";
        } else {
            btn.onclick = function() {
                selectTime(this, timeLabel);
            };
            availableCount++;
        }
        
        container.appendChild(btn);
    } // End of time slot loop

    if (availableCount === 0) {
        container.innerHTML = '<div style="grid-column: 1/-1; color: #888; text-align: center;">æœ¬æ—¥å·²ç„¡ç©ºæª”ï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸ</div>';
    }
}


// 7. è™•ç†æ™‚æ®µé¸æ“‡ (èˆ‡èˆŠç‰ˆç›¸åŒ)
function selectTime(btn, time) {
    const allBtns = document.querySelectorAll('.time-btn');
    allBtns.forEach(b => b.classList.remove('selected'));
    
    btn.classList.add('selected');
    document.getElementById('selectedTime').value = time;
}

// 8. é€å‡ºè¡¨å–® (èˆ‡èˆŠç‰ˆç›¸åŒï¼Œè«‹å‹™å¿…æ›¿æ›æ‚¨çš„ç¶²å€)
document.getElementById('bookingForm').addEventListener('submit', function(e) {
    e.preventDefault(); // é˜»æ­¢é é¢è·³è½‰

    const submitBtn = document.querySelector('.submit-btn');
    
    // ç²å–è³‡æ–™
    const serviceElement = document.getElementById('service');
    const service = serviceElement.options[serviceElement.selectedIndex].text;
    const staff = document.getElementById('staff').options[document.getElementById('staff').selectedIndex].text;
    const date = document.getElementById('date').value;
    const time = document.getElementById('selectedTime').value;
    const name = document.getElementById('name').value;
    const phone = document.getElementById('phone').value;

    const nickname = document.getElementById('nickname') ? document.getElementById('nickname').value : '';
    
    if (nickname.length > 0) {
        console.warn("åµæ¸¬åˆ°æ©Ÿå™¨äººè¡Œç‚ºï¼Œå·²é˜»æ­¢æäº¤ã€‚");
        alert("æäº¤å¤±æ•—ï¼Œè«‹å‹¿é‡è¤‡æäº¤ã€‚"); 
        return;
    }

    if (!time) {
        alert('è«‹é¸æ“‡é ç´„æ™‚æ®µï¼');
        return;
    }

    // --- è¨­å®šæ‚¨å‰›å‰›è¤‡è£½çš„ Google Apps Script ç¶²å€ ---
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzHV8KLPw390a8MIgQg1YTTt-g5B_ughmXB86jajc32dcBjmkaQ0p7vQ8qA99mPtPNY/exec'; 

    submitBtn.disabled = true;
    submitBtn.innerText = "é ç´„å‚³é€ä¸­...";

    // æ‰“åŒ…è³‡æ–™
    const formData = {
        service: service,
        staff: staff,
        date: date,
        time: time,
        name: name,
        phone: phone
    };

    // ç™¼é€è³‡æ–™åˆ° Google Sheet (ä½¿ç”¨ POST)
    fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify(formData),
        mode: 'no-cors', 
        headers: {
            'Content-Type': 'text/plain'
        }
    })
    .then(() => {
        alert(`âœ… é ç´„æˆåŠŸï¼\n\næ„Ÿè¬ ${name} çš„é ç´„\næˆ‘å€‘å·²å°‡è³‡è¨Šå‚³é€è‡³ç³»çµ±ã€‚`);
        document.getElementById('bookingForm').reset();
        document.getElementById('timeSlotsContainer').innerHTML = '<div style="grid-column: 1/-1; color: #888; text-align: center;">è«‹å…ˆé¸æ“‡æœå‹™é …ç›®èˆ‡æ—¥æœŸ</div>';
        document.getElementById('serviceDetail').style.display = 'none';
        submitBtn.disabled = false;
        submitBtn.innerText = "ç¢ºèªé ç´„";
        // æˆåŠŸå¾Œé‡è¨­ selectedServiceDuration
        selectedServiceDuration = 0; 
    })
    .catch(error => {
        console.error('Error!', error.message);
        alert('âŒ ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ï¼Œæˆ–ç›´æ¥è¯ç¹«æˆ‘å€‘ã€‚');
        submitBtn.disabled = false;
        submitBtn.innerText = "ç¢ºèªé ç´„";
    });
});

// åˆå§‹åŒ–ï¼šç¢ºä¿ç¶²é åŠ è¼‰æ™‚ updateServiceInfo è¢«åŸ·è¡Œä¸€æ¬¡
window.onload = function() {
    updateServiceInfo();
};
</script>

</body>
</html>
